!function(){function e(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?a:3&a|8).toString(16)});return t}function t(e,t){t||(t=location.href),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+e+"=([^&#]*)",n=new RegExp(a),o=n.exec(t);return null==o?null:o[1]}function a(){y.style("stroke-width",1.5/d3.event.scale+"px"),y.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function n(e){var t=w.bounds(topojson.feature(e,e.objects.municipalities)),a=.95/Math.max((t[1][0]-t[0][0])/h,(t[1][1]-t[0][1])/g),n=[(h-a*(t[1][0]+t[0][0]))/2,(g-a*(t[1][1]+t[0][1]))/2];v.scale(a).translate(n),e=null}function o(){if(x&&x.remove(),v=d3.geo.albersUsa().scale(1).translate([0,0]),w=d3.geo.path().projection(v),b=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([1,8]).on("zoom",a),x=d3.select("#map").append("svg").attr("width",h).attr("height",g),y=x.append("g"),x.call(b).call(b.event),null==j&&null==E)d3.json("data/cleaned-30.topojson",function(e,t){j=jQuery.extend(!0,{},t);for(var a=0;a<j.objects.municipalities.geometries.length;a++)A.push(j.objects.municipalities.geometries[a].properties.placefp);n(t),$.when($.ajax({url:"data/st-louis-county-muni-data-final.json",dataType:"json"})).then(function(e){E=jQuery.extend(!0,{},e),p(t)})});else{var e=jQuery.extend(!0,{},j);n(e),p(e),e=null}}function r(e){return"number"==typeof e?"$"+e.toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):e}function i(e){return"number"==typeof e?e.toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):e}function s(e){return"number"==typeof e?(e=100*e,e.toFixed(1).toString().concat("%")):e}function p(e){dataCopy=jQuery.extend(!0,{},e),y.selectAll("*").remove();var t,a,n=[];if(P.length>0){for(t=0;t<P.length;t++)for(a=0;a<P[t].munis.length;a++)n.push(P[t].munis[a]);for(t=0,a=0,t=dataCopy.objects.municipalities.geometries.length-1;t>=0;t--){var o=dataCopy.objects.municipalities.geometries[t].properties.placefp;n.indexOf(o)>-1&&dataCopy.objects.municipalities.geometries.splice(t,1)}}if(P.length>0&&1==C?($("#map-message").html('This is a map created by someone else. <br/>Click "reset" to make your own!'),$("#map-reset").prop("disabled",!1),$("#map-reset").addClass("animated").addClass("bounce")):P.length>0?($("#map-share").prop("disabled",!1),$("#map-reset").prop("disabled",!1)):($("#map-share").prop("disabled",!0),$("#map-reset").prop("disabled",!0)),y.selectAll("path").data(topojson.feature(dataCopy,dataCopy.objects.municipalities).features).enter().append("path").attr("class","muni").attr("data-name",function(e){return e.properties.name}).attr("data-placefp",function(e){return e.properties.placefp}).attr("data-population",function(e){return i(E[e.properties.placefp]["pop-total"])}).attr("data-income",function(e){return r(E[e.properties.placefp]["per-capita-income"])}).attr("data-pct-white",function(e){return s(E[e.properties.placefp]["pop-white"]/E[e.properties.placefp]["pop-total"])}).attr("data-pct-black",function(e){return s(E[e.properties.placefp]["pop-black"]/E[e.properties.placefp]["pop-total"])}).attr("data-pct-asian",function(e){return s(E[e.properties.placefp]["pop-asian"]/E[e.properties.placefp]["pop-total"])}).attr("data-pct-other",function(e){return s(E[e.properties.placefp]["pop-other"]/E[e.properties.placefp]["pop-total"])}).attr("d",w).on("click",c),t=0,a=0,P.length>0)for(t=0;t<P.length;t++){var p=P[t].munis,l=P[t].name,u=P[t].placefp,d=0,h=0,g=0,v=0,b=0,x=0;for(a=0;a<p.length;a++)d+=E[p[a]]["pop-total"],h+=E[p[a]]["pop-white"],g+=E[p[a]]["pop-black"],v+=E[p[a]]["pop-asian"],b+=E[p[a]]["pop-other"],x+=E[p[a]]["per-capita-income"]*E[p[a]]["pop-total"];var k="muni merged";y.append("path").datum(topojson.merge(e,e.objects.municipalities.geometries.filter(function(e){return p.indexOf(e.properties.placefp)>-1}))).attr("class",k).attr("merge-id",t.toString()).attr("data-name",l).attr("data-placefp",u).attr("data-population",function(){return i(d)}).attr("data-income",function(){return r(x/d)}).attr("data-pct-white",function(){return s(h/d)}).attr("data-pct-black",function(){return s(g/d)}).attr("data-pct-asian",function(){return s(v/d)}).attr("data-pct-other",function(){return s(b/d)}).attr("d",w).on("click",c)}if(y.append("path").datum(topojson.mesh(dataCopy,dataCopy.objects.municipalities,function(e,t){return e!=t})).attr("class","muni-boundary").attr("d",w),!O){var j;$("path.muni").on("mouseenter",function(){clearTimeout(j),m(),f(this)}),$("path.muni").on("mouseleave",function(){m(),j=setTimeout(function(){$("#map-stats").addClass("inactive")},50)})}}function c(){var e=this.getAttribute("data-placefp"),t=k.indexOf(this);t>=0?k.splice(t,1):k.push(this),k.length>0?($("#muni-controls").removeClass("inactive"),k.length>1?($("#map-merge").prop("disabled",!1),$("#map-split").prop("disabled",!0)):($("#map-merge").prop("disabled",!0),-1==A.indexOf(e)&&$("#map-split").prop("disabled",!1)),O&&(m(),f(this))):(u(),O&&(m(),$("#map-stats").addClass("inactive"))),l(),console.log("There was a click"),console.log("SELECTED: "+k);var a=k.slice(0);console.log("SELECTEDCOPY: "+a),d3.selectAll(a).classed("active",!0)}function l(){d3.selectAll(".muni").classed("active",!1)}function u(){$("#muni-controls").addClass("inactive"),$("#map-merge").prop("disabled",!0),$("#map-split").prop("disabled",!0),$("#map-reset").removeClass("animated").removeClass("bounce")}function d(){$("#map-message").empty(),C=!1}function m(){$("#map-stats").children("div span").each(function(){$(this).empty()})}function f(e){$("#stats-name span").text($(e).attr("data-name")),$("#stats-population span").text($(e).attr("data-population")),$("#stats-pct-white span").text($(e).attr("data-pct-white")),$("#stats-pct-black span").text($(e).attr("data-pct-black")),$("#stats-pct-asian span").text($(e).attr("data-pct-asian")),$("#stats-pct-other span").text($(e).attr("data-pct-other")),$("#stats-income span").text($(e).attr("data-income")),$("#map-stats").removeClass("inactive")}Array.prototype.randomElement=function(){return this[Math.floor(Math.random()*this.length)]},String.prototype.toTitleCase=function(){return this.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})};var h,g,v,w,b,x,y,C,k=[],P=[],j=null,E=null,A=[],O=!1,S=null,M=null;"undefined"!==navigator.userAgent&&(S=navigator.userAgent),"undefined"!==navigator.platform&&(S=navigator.platform),jQuery(document).ready(function(a){if("none"==a("#map-selectall").css("display")&&(O=!0),a("html").hasClass("ie"))throw a("#control-wrapper").empty(),a(".popup").remove(),a("#map-message").html('<p>Uh oh. It looks like your browser can not run our "Build a New St. Louis" app. <a href="http://browsehappy.com/">Please upgrade your browser.</a></p>').show(),a("#map-message").css("position","relative").css("left","auto").css("margin-left","auto").css("margin-right","auto").css("text-align","center"),new Error("Error: This app requires a newer browser.");if(O)a("#shareUr").replaceWith('<a class="shareButton sharePop" id="shareUr" href="#" target="_blank"><span>Link</span><i class="fa fa-link"></i></a>');else if("ZeroClipboard"in window){var n=new ZeroClipboard(document.getElementById("shareUr"));n.on("copy",function(){a("#share-popup p").animate({opacity:1})})}if(h=a("#map").width(),g=a("#map").height(),O)var r=["auto",80];else var r=["auto","auto"];var i=a("#explainer-popup").bPopup({position:r,onOpen:function(){window.scroll(0,0)},onClose:function(){window.scroll(0,0)}});a("#explainer-popup").on("click",function(){i.close()}),o();var s=t("id");if(s){var c=JSON.stringify({id:s});a.get("https://openws.herokuapp.com/new-st-louis?q="+c+"&apiKey=7392f58173720e6bd8292b615b708801").done(function(e){if("undefined"!==e[0]&&"undefined"!==e[0].merges)P=e[0].merges,C=!0;else{P=[],C=!1;var t={interactive:"build-a-new-st-louis",transaction:"get",data:e,userAgent:S,platform:M};a.post("https://openws.herokuapp.com/errors?apiKey=7392f58173720e6bd8292b615b708801",t)}}).fail(function(e){P=[],C=!1;var t={interactive:"build-a-new-st-louis",transaction:"get",data:e,userAgent:S,platform:M};a.post("https://openws.herokuapp.com/errors?apiKey=7392f58173720e6bd8292b615b708801",t)})}else C=!1;a("#map-share").prop("disabled",!0),a("#map-reset").prop("disabled",!0),a("#map-reset").removeClass("animated").removeClass("bounce"),a(window).on("resize",function(){h=a("#map").width(),g=a("#map").height(),o()}),a("#map-merge").on("click",function(){O&&(m(),a("#map-stats").addClass("inactive"));var e=a("#merge-name-popup").bPopup({onOpen:function(){window.scroll(0,0),namePieces={pre:[],pieces:[],suf:[],words:[]};for(var e=[],t=[],n=[],o=!1,r=!1,i=0;i<k.length;i++){var s=k[i].getAttribute("data-placefp");if("65000"==s?o=!0:"99999"==s&&(r=!0),A.indexOf(s)>-1)namePieces.pre=namePieces.pre.concat(E[s].pre),namePieces.pieces=namePieces.pieces.concat(E[s].pieces),namePieces.suf=namePieces.suf.concat(E[s].suf),namePieces.words=namePieces.words.concat(E[s].words),t.push(k[i].getAttribute("data-name")),e=e.concat(E[s].pre),e=e.concat(E[s].pieces),e=e.concat(E[s].suf),e=e.concat(E[s].words);else for(var p=P.length-1;p>=0;p--)if(P[p].placefp==s)for(var c=0;c<P[p].munis.length;c++){var l=P[p].munis[c];"65000"==s?o=!0:"99999"==s&&(r=!0),namePieces.pre=namePieces.pre.concat(E[l].pre),namePieces.pieces=namePieces.pieces.concat(E[l].pieces),namePieces.suf=namePieces.suf.concat(E[l].suf),namePieces.words=namePieces.words.concat(E[l].words),e=e.concat(E[l].pre),e=e.concat(E[l].pieces),e=e.concat(E[l].suf),e=e.concat(E[l].words);var u=j.objects.municipalities.geometries.filter(function(e){return e.properties.placefp==l});t.push(u[0].properties.name)}}var d=.2,m=.3,f=.2,h=.5,g=.9;namePieces.words.length<1&&(d-=.1,f-=.1,m-=.1),namePieces.pieces.length<1&&(d=0,f=0);for(var v=0;5>v;v++){var w=0;do{if(w++,w>30)break;var b="";if(namePieces.pre.length>0&&Math.random()>d&&(b+=namePieces.pre.randomElement()),namePieces.pieces.length>0&&Math.random()>m&&(b+=namePieces.pieces.randomElement()),namePieces.suf.length>0&&Math.random()>f&&(b+=namePieces.suf.randomElement()),namePieces.words.length>0&&Math.random()>h){var x=namePieces.words.randomElement();b+=" ",b+=x;var y=namePieces.words.indexOf(x);namePieces.words.splice(y,1)}namePieces.words.length>0&&Math.random()>g&&(b+=" ",b+=namePieces.words.randomElement()),b=b.toTitleCase().trim(),b=b.replace(/(.)\1{2,}/g,"$1$1"),b=b.replace("eette","ette"),("St."==b||"Louis"==b)&&(b="St. Louis")}while(t.indexOf(b)>-1||n.indexOf(b)>-1);b>""&&n.push(b)}n=n.filter(function(e,t,a){return a.indexOf(e)==t});for(var $=0;$<e.length;$++)e[$]=e[$].toTitleCase().trim();o?a("#merge-name-popup select").append("<option>St. Louis</option>"):r&&a("#merge-name-popup select").append("<option>Unincorporated St. Louis County</option>");for(var C=0;C<n.length;C++)-1==t.indexOf(n[C])&&-1==e.indexOf(n[C])&&a("#merge-name-popup select").append("<option>"+n[C]+"</option>")},onClose:function(){window.scroll(0,0);var e=a("#merge-name-popup option:selected").text();!e.trim()>""&&(e="Merged municipality"),a("#merge-name-popup select").empty();var t={};t.name=e,t.munis=[];for(var n=0;n<k.length;n++){var o=k[n].getAttribute("data-placefp");if(A.indexOf(o)>-1)t.munis.push(o);else for(var r=P.length-1;r>=0;r--)if(P[r].placefp==o){for(var i=0;i<P[r].munis.length;i++)t.munis.push(P[r].munis[i]);P.splice(r,1)}}var s=t.munis.reduce(function(e,t){return parseInt(e)+parseInt(t)});t.placefp=(s*Math.random()).toString(36).substr(2,5),P.push(t),d(),u(),k.length=0,p(j)}});a("#merge-name-popup button").on("click",function(){e.close()}),a("#merge-name-popup input").keyup(function(t){13==t.keyCode&&e.close()})}),a("#map-split").on("click",function(){O&&(m(),a("#map-stats").addClass("inactive"));for(var e=0;e<k.length;e++){var t=k[e].getAttribute("data-placefp");if(-1==A.indexOf(t))for(var n=P.length-1;n>=0;n--)P[n].placefp==t&&P.splice(n,1)}d(),u(),k.length=0,p(j)}),a("#map-share").on("click",function(){if(P.length>0&&0==C){var t="https://graphics.stltoday.com/apps/build-a-new-st-louis/index.html",n="https://www.facebook.com/sharer.php?u=",o="https://twitter.com/intent/tweet?source=tweetbutton&text=I%20just%20built%20a%20new%20St.%20Louis.&20&hashtags=onestl&url=",r={};r.merges=P,r.id=e(),a.post("https://openws.herokuapp.com/new-st-louis?apiKey=7392f58173720e6bd8292b615b708801",r).done(function(){t=t+"?id="+r.id}).fail(function(e){var t={interactive:"build-a-new-st-louis",transaction:"post",data:e,userAgent:S,platform:M};a.post("https://openws.herokuapp.com/errors?apiKey=7392f58173720e6bd8292b615b708801",t)}).always(function(){n+=t,o=o+t+"&via=stltoday",a("#shareFb").attr("href",n),a("#shareTw").attr("href",o),O?a("#shareUr").attr("href",t):a("#shareUr").attr("data-clipboard-text",t);a("#share-popup").bPopup({onClose:function(){window.scroll(0,0),a("#share-popup p").css({opacity:0})}})})}}),a(".sharePop").click(function(){var e=575,t=253,n=(a(window).width()-e)/2,o=(a(window).height()-t)/2,r=this.href,i="status=1,width="+e+",height="+t+",top="+o+",left="+n;return window.open(r,"_blank",i),!1}),jQuery.fn.d3Click=function(){this.each(function(e,t){var a=document.createEvent("MouseEvents");a.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(a)})},a("#map-selectall").on("click",function(){O&&(m(),a("#map-stats").addClass("inactive")),k.length=0,y.selectAll("path.muni").each(function(){a(this).d3Click()})}),a("#map-reset").on("click",function(){O&&(m(),a("#map-stats").addClass("inactive")),d(),u(),k.length=0,P.length=0,p(j)})})}();